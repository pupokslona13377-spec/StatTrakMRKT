<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatTrak Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #0f172a; color: white; padding-bottom: 80px; }
        .header { background: #1e293b; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .header h1 { font-size: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .search-box { width: 100%; padding: 12px; background: #0f172a; border: 2px solid #334155; border-radius: 12px; color: white; margin-top: 10px; }
        .section { display: none; padding: 20px; }
        .section.active { display: block; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .item-card { background: #1e293b; border-radius: 12px; padding: 15px; text-align: center; border-bottom: 4px solid #475569; }
        .item-card img { width: 100%; max-width: 100px; height: auto; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }
        .item-price { color: #10b981; font-weight: bold; margin: 5px 0; }
        .btn { padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-success { background: #10b981; color: white; }
        .btn-primary { background: #667eea; color: white; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; display: flex; justify-content: space-around; padding: 10px 0 25px 0; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: #667eea; }
        .toast-container { position: fixed; bottom: 90px; left: 20px; right: 20px; z-index: 10000; }
        .toast { background: #1e293b; color: white; padding: 12px; border-radius: 8px; border-left: 4px solid #667eea; margin-top: 5px; }
        /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–µ–π */
        .rarity-ancient { border-bottom-color: #eb4b4b; box-shadow: 0 4px 15px rgba(235, 75, 75, 0.3); }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="header">
        <h1>üéØ StatTrak Market</h1>
        <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤..." oninput="filterMarket()">
    </div>

    <div class="section active" id="marketSection">
        <div style="color: #10b981; font-weight: bold; margin-bottom: 10px;">–ë–∞–ª–∞–Ω—Å: <span id="m-balance">0.00</span> TON</div>
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div class="section" id="inventorySection">
        <div class="items-grid" id="inventoryGrid"></div>
    </div>

    <div class="section" id="profileSection">
        <div style="background: #1e293b; padding: 20px; border-radius: 15px; text-align: center;">
            <h2 id="p-balance">0.00 TON</h2>
            <p style="color: #94a3b8; font-size: 12px;">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
            <button class="btn btn-success" onclick="depositFunds()" style="margin: 15px 0;">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
            <input type="text" id="steamIdInput" placeholder="SteamID64" style="width:100%; padding:10px; border-radius:8px; background:#0f172a; border:1px solid #334155; color:white; margin-top:10px;">
            <button class="btn btn-primary" onclick="saveData()" style="margin-top:10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å ID</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchSection('market')">üõí<span>–ú–∞—Ä–∫–µ—Ç</span></button>
        <button class="nav-btn" onclick="switchSection('inventory')">üéí<span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
        <button class="nav-btn" onclick="switchSection('profile')">üë§<span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </nav>

    <script>
        const API_URL = "https://stattrakmrkt.onrender.com";
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const userId = tg.initDataUnsafe?.user?.id || 12345;
        let userBalance = 0;

        function showToast(text) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function syncBalance() {
            try {
                const res = await fetch(`${API_URL}/api/user/${userId}`);
                const data = await res.json();
                userBalance = data.balance;
                document.getElementById('m-balance').innerText = userBalance.toFixed(2);
                document.getElementById('p-balance').innerText = userBalance.toFixed(2) + " TON";
            } catch (e) { console.error(e); }
        }

        async function loadMarket() {
            const grid = document.getElementById('marketGrid');
            grid.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                const res = await fetch(`${API_URL}/api/market`);
                const items = await res.json();
                grid.innerHTML = items.map(i => `
                    <div class="item-card ${i.rarity || ''}">
                        <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.hash}/200fx200f">
                        <div class="item-name" style="font-size:12px; margin:5px 0;">${i.name}</div>
                        <div class="item-price">${i.price} TON</div>
                        <button class="btn btn-success" onclick="buyItem('${i.id}', ${i.price}, '${i.name}')">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `).join('');
            } catch (e) { showToast("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); }
        }

        async function buyItem(itemId, price, name) {
            if (userBalance < price) {
                showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                return;
            }
            if (!confirm(`–ö—É–ø–∏—Ç—å ${name}?`)) return;

            const res = await fetch(`${API_URL}/api/market/buy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, itemId: itemId })
            });
            
            if (res.ok) {
                showToast("–ö—É–ø–ª–µ–Ω–æ!");
                syncBalance();
                loadMarket();
            } else {
                const err = await res.json();
                showToast(err.message);
            }
        }

        async function depositFunds() {
            const amount = prompt("–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (—Ç–µ—Å—Ç):", "10");
            if (!amount) return;
            await fetch(`${API_URL}/api/user/deposit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, amount: amount })
            });
            syncBalance();
            showToast("–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!");
        }

        function switchSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            if (section === 'market') loadMarket();
            if (section === 'profile') syncBalance();
        }

        function saveData() {
            localStorage.setItem('sid', document.getElementById('steamIdInput').value);
            showToast("ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        }

        window.onload = () => {
            document.getElementById('steamIdInput').value = localStorage.getItem('sid') || '';
            syncBalance();
            loadMarket();
        };
    </script>
</body>
</html>





