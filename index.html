<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StatTrak Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ============ –ü–û–õ–ù–´–ï –°–¢–ò–õ–ò –ò–ó –ü–ï–†–í–û–ì–û –ü–†–û–ú–ü–¢–ê ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #F8F9FA;
            color: #212529;
            padding-bottom: 70px;
            overflow-x: hidden;
        }

        .header {
            background: #FFFFFF;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-accent {
            color: #00D2FF;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E9ECEF;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #F8F9FA;
        }

        .search-box:focus {
            outline: none;
            border-color: #00D2FF;
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.1);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFFFF;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-top: 3px solid transparent;
            color: #6C757D;
        }

        .nav-item.active {
            color: #00D2FF;
            border-top-color: #00D2FF;
        }

        .nav-icon {
            font-size: 22px;
            display: block;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }

        .section {
            display: none;
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 210, 255, 0.15);
        }

        .item-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            border-radius: 8px;
            padding: 10px;
        }

        .item-name {
            font-size: 13px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 6px;
            line-height: 1.3;
            height: 34px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .item-price {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 700;
            color: #00D2FF;
        }

        .profile-header {
            background: linear-gradient(135deg, #00D2FF 0%, #0099CC 100%);
            border-radius: 16px;
            padding: 25px;
            color: #FFFFFF;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .pending-balance {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            margin-top: 15px;
        }

        .steam-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E9ECEF;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .btn-save {
            width: 100%;
            padding: 14px;
            background: #00D2FF;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ============ –°–¢–ò–õ–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ò–ó –í–¢–û–†–û–ì–û –ü–†–û–ú–ü–¢–ê ============ */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            border-radius: 8px; color: white; font-weight: 500;
            opacity: 0; transform: translateX(400px); transition: all 0.3s ease;
            z-index: 10000; max-width: 300px;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification-error { background: #e74c3c; }
        .notification-success { background: #2ecc71; }
        .notification-info { background: #3498db; }
        
        .game-hub-blur { filter: blur(8px); opacity: 0.6; }
        .coming-soon-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 10; background: rgba(255,255,255,0.95);
            padding: 30px; border-radius: 16px; width: 80%;
        }
    </style>
</head>
<body>

    <div id="loader" class="loader"><div class="spinner"></div></div>

    <div class="header">
        <h1>üíé <span class="header-accent">StatTrak Market</span></h1>
        <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤...">
    </div>

    <div class="section active" id="market">
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div class="section" id="orders">
        <div id="ordersContainer" class="empty-state" style="text-align: center; padding-top: 50px;">
            <div style="font-size: 64px; opacity: 0.5;">üì¶</div>
            <p style="color: #6C757D;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</p>
        </div>
    </div>

    <div class="section" id="gameHub">
        <div class="game-hub-container" style="position: relative;">
            <div class="coming-soon-overlay">
                <h2>üéÆ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h2>
                <p>–ò–≥—Ä–æ–≤–æ–π —Ä–∞–∑–¥–µ–ª —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!</p>
            </div>
            <div class="game-hub-blur">
                <div class="items-grid">
                    <div class="item-card"><div style="height:120px; background:#eee;"></div></div>
                    <div class="item-card"><div style="height:120px; background:#eee;"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section" id="profile">
        <div class="profile-header">
            <div style="font-size: 14px; opacity: 0.9;">üí∞ –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount" id="balanceDisplay">$0.00</div>
            
            <div class="pending-balance">
                <div style="font-size: 13px; margin-bottom: 6px;">‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏</div>
                <div style="font-size: 18px; font-weight: 600;" id="pendingBalanceDisplay">0.00 TON</div>
            </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <h3 style="font-size: 16px; margin-bottom: 12px;">üîó Steam ID64</h3>
            <input type="text" id="steamIdInput" class="steam-input" placeholder="76561198...">
            <button class="btn-save" onclick="handleSaveSteamId()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <h3 style="margin: 20px 0 10px;">üéí –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div id="inventoryGrid" class="items-grid"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-market" onclick="switchSection('market')">
            <span class="nav-icon">üõí</span><span class="nav-label">–ú–∞—Ä–∫–µ—Ç</span>
        </div>
        <div class="nav-item" id="nav-orders" onclick="switchSection('orders')">
            <span class="nav-icon">üì¶</span><span class="nav-label">–ó–∞–∫–∞–∑—ã</span>
        </div>
        <div class="nav-item" id="nav-gameHub" onclick="switchSection('gameHub')">
            <span class="nav-icon">üéÆ</span><span class="nav-label">–•–∞–±</span>
        </div>
        <div class="nav-item" id="nav-profile" onclick="switchSection('profile')">
            <span class="nav-icon">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        // ============ –ü–û–õ–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–ó –í–¢–û–†–û–ì–û –ü–†–û–ú–ü–¢–ê (–ë–ï–ó –°–û–ö–†–ê–©–ï–ù–ò–ô) ============
        const API_BASE = 'https://stattrakmrkt.onrender.com';
        const tg = window.Telegram.WebApp;

        tg.expand();
        tg.ready();

        let currentUser = {
            userId: null,
            steamId: null,
            balance: 0
        };

        function initUser() {
            const savedSteamId = localStorage.getItem('steamId64');
            const savedUserId = localStorage.getItem('userId');
            
            if (savedSteamId) currentUser.steamId = savedSteamId;
            
            if (tg.initDataUnsafe?.user?.id) {
                currentUser.userId = tg.initDataUnsafe.user.id;
                localStorage.setItem('userId', currentUser.userId);
            } else if (savedUserId) {
                currentUser.userId = savedUserId;
            }
        }

        async function loadMarket() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/market`);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const data = await response.json();
                renderMarketItems(data.items || data);
            } catch (error) {
                console.error('Error loading market:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞');
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        async function loadInventory(steamId) {
            if (!steamId) return;
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/inventory/${steamId}`);
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const data = await response.json();
                renderInventoryItems(data.items || data);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è');
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        async function syncBalance() {
            if (!currentUser.userId) return;
            try {
                const response = await fetch(`${API_BASE}/api/user/${currentUser.userId}`);
                if (!response.ok) throw new Error();
                const data = await response.json();
                currentUser.balance = data.balance || 0;
                document.getElementById('balanceDisplay').textContent = `$${currentUser.balance.toFixed(2)}`;
            } catch (error) {
                console.error('Balance sync failed');
            }
        }

        async function buyItem(itemId, price) {
            if (currentUser.balance < price) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            
            if (!confirm(`–ö—É–ø–∏—Ç—å –∑–∞ $${price.toFixed(2)}?`)) return;
            
            try {
                showLoader();
                tg.HapticFeedback.impactOccurred('medium');
                const response = await fetch(`${API_BASE}/api/market/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, buyerId: currentUser.userId, price })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
                
                tg.HapticFeedback.notificationOccurred('success');
                showSuccess('–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!');
                await syncBalance();
                await loadMarket();
            } catch (error) {
                showError(error.message);
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        function renderMarketItems(items) {
            const grid = document.getElementById('marketGrid');
            grid.innerHTML = '';
            if (!items || items.length === 0) {
                grid.innerHTML = '<p class="no-items">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>';
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <img class="item-image" src="${item.image || 'https://via.placeholder.com/150'}" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">
                        <span>$${parseFloat(item.price).toFixed(2)}</span>
                        <button class="btn-save" style="padding: 5px 10px; width: auto; font-size: 12px;" onclick="buyItem('${item.id}', ${item.price})">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderInventoryItems(items) {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            if (!items || items.length === 0) {
                grid.innerHTML = '<p class="no-items">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <img class="item-image" src="${item.image || 'https://via.placeholder.com/150'}">
                    <div class="item-name">${item.name}</div>
                    <input type="number" class="search-box" style="margin-bottom:5px; height:30px;" placeholder="–¶–µ–Ω–∞ $" id="price-${item.id}">
                    <button class="btn-save" style="height:35px;" onclick="listItemFromInventory('${item.id}', '${item.name}', '${item.market_hash_name || item.name}')">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
                `;
                grid.appendChild(card);
            });
        }

        function listItemFromInventory(itemId, name, hash) {
            const pInput = document.getElementById(`price-${itemId}`);
            const price = parseFloat(pInput.value);
            if (!price || price <= 0) return showError('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É');
            listItem(name, price, hash);
        }

        async function listItem(name, price, hash) {
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/market/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sellerId: currentUser.userId,
                        steamId: currentUser.steamId,
                        itemName: name,
                        price: price,
                        marketHash: hash
                    })
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è');
                showSuccess('–ü—Ä–µ–¥–º–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω!');
                loadInventory(currentUser.steamId);
            } catch (e) { showError(e.message); }
            finally { hideLoader(); }
        }

        function handleSaveSteamId() {
            const input = document.getElementById('steamIdInput');
            if (!input.value) return showError('–í–≤–µ–¥–∏—Ç–µ Steam ID');
            currentUser.steamId = input.value;
            localStorage.setItem('steamId64', input.value);
            tg.HapticFeedback.notificationOccurred('success');
            showSuccess('Steam ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            loadInventory(input.value);
        }

        function switchSection(id) {
            tg.HapticFeedback.impactOccurred('light');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
            
            if (id === 'market') loadMarket();
            if (id === 'profile') {
                syncBalance();
                if (currentUser.steamId) loadInventory(currentUser.steamId);
            }
        }

        function showLoader() { document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        function showError(m) { showNotification(m, 'error'); }
        function showSuccess(m) { showNotification(m, 'success'); }

        function showNotification(message, type) {
            const n = document.createElement('div');
            n.className = `notification notification-${type}`;
            n.textContent = message;
            document.body.appendChild(n);
            setTimeout(() => n.classList.add('show'), 10);
            setTimeout(() => {
                n.classList.remove('show');
                setTimeout(() => n.remove(), 300);
            }, 3000);
        }

        // INIT
        initUser();
        loadMarket();
        syncBalance();
        if (currentUser.steamId) {
            document.getElementById('steamIdInput').value = currentUser.steamId;
        }
    </script>
</body>
</html>


