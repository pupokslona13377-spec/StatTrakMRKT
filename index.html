<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STATTRAK MARKET | ULTIMATE TITAN EDITION</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ============================================================
           1. ПРЕМИАЛЬНАЯ СИСТЕМА СТИЛЕЙ (GLASSMORPHISM 2.0)
           ============================================================
        */
        :root {
            --accent: #00D2FF;
            --accent-glow: rgba(0, 210, 255, 0.4);
            --ton-blue: #0088CC;
            --bg-dark: #070B14;
            --card-bg: rgba(30, 41, 59, 0.5);
            --text-main: #FFFFFF;
            --text-dim: #94A3B8;
            --border: rgba(255, 255, 255, 0.08);
            --glass-blur: blur(15px);
            --gradient-ton: linear-gradient(135deg, #00D2FF 0%, #0088CC 100%);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: 100px;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        /* АНИМАЦИИ */
        @keyframes pulse-premium {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; filter: brightness(1.2); }
            100% { transform: scale(1); opacity: 0.7; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* СКЕЛЕТОНЫ ЗАГРУЗКИ */
        .skeleton {
            background: linear-gradient(90deg, #1E293B 25%, #334155 50%, #1E293B 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ============================================================
           2. HEADER (УМЕНЬШЕННАЯ "БРОВЬ")
           ============================================================
        */
        header {
            position: sticky; top: 0; z-index: 2000;
            background: rgba(7, 11, 20, 0.75);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px; /* Уменьшили высоту */
        }
        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .logo { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }

        .search-container { position: relative; width: 100%; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: 0.4; width: 16px; }
        .search-bar {
            width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);
            padding: 10px 15px 10px 40px; border-radius: 12px; color: white;
            font-size: 14px; outline: none; transition: 0.3s;
        }
        .search-bar:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }

        /* ============================================================
           3. КАРТОЧКА TON (ПРОФИЛЬ)
           ============================================================
        */
        .ton-card {
            background: var(--gradient-ton);
            border-radius: 24px; padding: 20px; margin: 15px;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.2);
            height: 160px; /* Немного уменьшили */
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .ton-card::after {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%; filter: blur(30px);
        }
        .ton-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
        .ton-balance { display: flex; align-items: center; gap: 12px; font-size: 36px; font-weight: 900; }
        
        /* ИДЕАЛЬНЫЙ SVG TON */
        .ton-gem { width: 32px; height: 32px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }

        .ton-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ton-btn {
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 10px; border-radius: 12px; font-weight: 800; font-size: 12px;
            backdrop-filter: blur(5px);
        }

        /* ============================================================
           4. МАРКЕТ И СЕТКА ПРЕДМЕТОВ
           ============================================================
        */
        .page { display: none; padding: 10px; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        .items-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .item-card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 20px; padding: 12px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .item-card:active { transform: scale(0.96); }
        .item-img-container {
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 14px; height: 110px; display: flex; align-items: center;
            justify-content: center; margin-bottom: 10px;
        }
        .item-img { max-width: 90%; max-height: 90%; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); }
        
        .item-name {
            font-size: 12px; font-weight: 700; color: #E2E8F0;
            height: 34px; overflow: hidden; margin-bottom: 8px; line-height: 1.2;
        }
        .item-price-row { display: flex; align-items: center; gap: 5px; font-weight: 900; font-size: 15px; color: var(--accent); }
        .ton-icon-mini { width: 14px; height: 14px; fill: var(--accent); }

        .buy-btn {
            width: 100%; padding: 10px; border-radius: 12px; border: none;
            background: var(--accent); color: var(--bg-dark); font-weight: 900;
            font-size: 11px; text-transform: uppercase; margin-top: 8px;
        }

        /* ============================================================
           5. ГЕЙМ ХАБ (PREMIUM BLUR)
           ============================================================
        */
        .hub-banner {
            height: 350px; border-radius: 30px; border: 1px solid var(--border);
            background: url('https://rare-gallery.com/uploads/posts/301308-csgo-counter-strike-global-offensive-video-game.jpg') center/cover;
            position: relative; overflow: hidden; margin-top: 10px;
        }
        .hub-blur {
            position: absolute; inset: 0; background: rgba(7, 11, 20, 0.7);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .badge-pulse {
            background: var(--accent); color: var(--bg-dark);
            padding: 6px 16px; border-radius: 50px; font-weight: 900; font-size: 12px;
            margin-bottom: 15px; animation: pulse-premium 2s infinite;
        }
        .hub-title { font-size: 34px; font-weight: 900; letter-spacing: -1px; margin-bottom: 10px; }

        /* ============================================================
           6. ИНВЕНТАРЬ И STEAM LOGIN
           ============================================================
        */
        .steam-login-box {
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
            border-radius: 20px; padding: 25px; margin: 15px; text-align: center;
        }
        .steam-btn {
            background: #171a21; color: white; border: none; padding: 12px 20px;
            border-radius: 10px; font-weight: 700; display: flex; align-items: center;
            justify-content: center; gap: 10px; width: 100%; margin-top: 15px;
            border: 1px solid #2a475e;
        }
        .steam-logo-svg { width: 20px; height: 20px; fill: white; }

        .tab-bar {
            display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 14px;
            padding: 4px; margin: 15px; border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1; padding: 10px; text-align: center; border-radius: 10px;
            font-size: 12px; font-weight: 800; color: var(--text-dim);
        }
        .tab-btn.active { background: var(--accent); color: var(--bg-dark); }

        /* ============================================================
           7. НАВИГАЦИЯ
           ============================================================
        */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(7, 11, 20, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: flex;
            justify-content: space-around; padding: 12px 10px 30px; z-index: 5000;
        }
        .nav-link { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 800; }
        .nav-link.active { color: var(--accent); }
        .nav-link svg { width: 24px; height: 24px; }

        /* TOASTS */
        #toast-wrap { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; }
        .toast { background: rgba(30, 41, 59, 0.9); border: 1px solid var(--accent); color: white; padding: 15px; border-radius: 16px; margin-bottom: 10px; backdrop-filter: blur(10px); animation: slideIn 0.3s ease; }
    </style>
</head>
<body>

    <svg style="display: none;">
        <symbol id="ton-gem" viewBox="0 0 56 56">
            <path d="M28 56C43.464 56 56 43.464 56 28C56 12.536 43.464 0 28 0C12.536 0 0 12.536 0 28C0 43.464 12.536 56 28 56ZM14.5607 15.7513C14.7963 15.3979 15.228 15.2158 15.6318 15.2995L27.6318 17.7995C27.8727 17.8497 28.1273 17.8497 28.3682 17.7995L40.3682 15.2995C40.772 15.2158 41.2037 15.3979 41.4393 15.7513C41.6749 16.1047 41.6738 16.5701 41.4367 16.9234L28.9367 35.4234C28.5146 36.0487 27.4854 36.0487 27.0633 35.4234L14.5633 16.9234C14.3262 16.5701 14.3251 16.1047 14.5607 15.7513Z"/>
        </symbol>
    </svg>

    <div id="toast-wrap"></div>

    <header>
        <div class="header-content">
            <div class="logo">STAT<span>TRAK</span></div>
            <div id="user-badge" style="font-size: 11px; font-weight: 800; color: var(--accent); background: rgba(0,210,255,0.1); padding: 5px 12px; border-radius: 20px;">ONLINE</div>
        </div>
        <div id="search-box" class="search-container">
            <span class="search-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
            <input type="text" id="main-search" class="search-bar" placeholder="Поиск скинов..." oninput="searchSkins()">
        </div>
    </header>

    <main id="page-market" class="page active">
        <div class="items-grid" id="market-list">
            </div>
    </main>

    <section id="page-hub" class="page">
        <div class="hub-banner">
            <div class="hub-blur">
                <div class="badge-pulse">В РАЗРАБОТКЕ</div>
                <h2 class="hub-title">GAME HUB</h2>
                <p style="color: var(--text-dim); max-width: 280px; font-size: 14px;">Новые способы получения скинов и мини-игры появятся в следующем крупном обновлении.</p>
            </div>
        </div>
    </section>

    <section id="page-profile" class="page">
        <div class="ton-card">
            <div>
                <p class="ton-label">Доступно TON</p>
                <div class="ton-balance">
                    <svg class="ton-gem"><use xlink:href="#ton-gem"></use></svg>
                    <span id="ton-val">0.00</span>
                </div>
            </div>
            <div class="ton-actions">
                <button class="ton-btn" onclick="showToast('Депозит скоро будет доступен')">ПОПОЛНИТЬ</button>
                <button class="ton-btn" onclick="showToast('Вывод от 1.5 TON')">ВЫВЕСТИ</button>
            </div>
        </div>

        <div class="steam-login-box">
            <span class="input-label" style="display: block; text-align: left; margin-bottom: 10px;">STEAM ID (64-BIT)</span>
            <input type="text" id="steam-id-input" class="sid-input" placeholder="76561198..." style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border); padding: 14px; border-radius: 12px; color: white; outline: none; margin-bottom: 15px;">
            <button class="steam-btn" onclick="saveSteamId()">
                <svg class="steam-logo-svg" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm.018 18.018c-3.197 0-5.787-2.59-5.787-5.787 0-3.197 2.59-5.787 5.787-5.787 3.197 0 5.787 2.59 5.787 5.787 0 3.197-2.59 5.787-5.787 5.787zM12 8.4a3.6 3.6 0 100 7.2 3.6 3.6 0 000-7.2z"/></svg>
                ПРИВЯЗАТЬ STEAM
            </button>
        </div>

        <div class="tab-bar">
            <div id="tab-inventory" class="tab-btn active" onclick="setTab('inv')">ИНВЕНТАРЬ</div>
            <div id="tab-history" class="tab-btn" onclick="setTab('hist')">ИСТОРИЯ</div>
        </div>

        <div id="inv-status" style="text-align:center; font-size:11px; color:var(--accent); font-weight:800; margin-bottom:10px;"></div>
        <div id="inventory-list" class="items-grid"></div>
    </section>

    <nav class="nav-bar">
        <a href="javascript:void(0)" class="nav-link active" onclick="navigate('market', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
            МАРКЕТ
        </a>
        <a href="javascript:void(0)" class="nav-link" onclick="navigate('hub', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h4M8 10v4M15 13a1 1 0 100-2 1 1 0 000 2z"/></svg>
            ХАБ
        </a>
        <a href="javascript:void(0)" class="nav-link" onclick="navigate('profile', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            ПРОФИЛЬ
        </a>
    </nav>

    <script>
        /* ============================================================
           8. ЯДРО ПРИЛОЖЕНИЯ (ЛОГИКА)
           ============================================================
        */
        const API = 'https://stattrakmrkt.onrender.com';
        const tg = window.Telegram.WebApp;
        let marketItems = [];

        window.onload = () => {
            tg.ready(); tg.expand();
            
            // Загружаем сохраненный Steam ID
            const savedSid = localStorage.getItem('user_sid64');
            if (savedSid) document.getElementById('steam-id-input').value = savedSid;

            fetchMarket();
            
            // Убираем интро если нужно (тут можно добавить прелоадер)
        };

        // НАВИГАЦИЯ
        function navigate(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            el.classList.add('active');

            // Поиск только в маркете
            document.getElementById('search-box').style.display = (page === 'market') ? 'block' : 'none';

            if (page === 'profile') fetchInventory();
            tg.HapticFeedback.impactOccurred('light');
        }

        // РАБОТА С МАРКЕТОМ
        async function fetchMarket() {
            try {
                const r = await fetch(`${API}/api/market`);
                marketItems = await r.json();
                renderItems(marketItems, 'market-list', true);
            } catch (e) {
                document.getElementById('market-list').innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.3;">Маркет временно пуст</p>';
            }
        }

        // УНИВЕРСАЛЬНЫЙ РЕНДЕРЕР (С ИСПРАВЛЕННЫМИ КАРТИНКАМИ)
        function renderItems(items, containerId, isMarket = false) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:20px;opacity:0.3;">Ничего не найдено</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                // ТИТАНОВАЯ ЛОГИКА ОПРЕДЕЛЕНИЯ КАРТИНКИ
                let rawImg = item.icon_url || item.image || item.img;
                let finalImg = '';

                if (rawImg) {
                    if (rawImg.includes('http')) {
                        finalImg = rawImg;
                    } else {
                        finalImg = `https://community.cloudflare.steamstatic.com/economy/image/${rawImg}/330x192`;
                    }
                } else {
                    // Заглушка если совсем ничего нет
                    finalImg = 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVdgYpw23d9dfHldogjSA1BW7mD8v_k_W4RS04_IiH6NBX8j66F8WLY';
                }

                return `
                <div class="item-card">
                    <div class="item-img-container">
                        <img src="${finalImg}" class="item-img" onerror="this.src='https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVdgYpw23d9dfHldogjSA1BW7mD8v_k_W4RS04_IiH6NBX8j66F8WLY'">
                    </div>
                    <div class="item-name">${item.name || item.market_hash_name || 'Неизвестный предмет'}</div>
                    <div class="item-price-row">
                        <svg class="ton-icon-mini"><use xlink:href="#ton-gem"></use></svg>
                        ${item.price || '0.00'}
                    </div>
                    <button class="buy-btn" onclick="${isMarket ? `buyItem('${item.id}')` : `sellItem('${item.id}')`}">${isMarket ? 'Купить' : 'Продать'}</button>
                </div>`;
            }).join('');
        }

        // ИСПРАВЛЕННЫЙ ИНВЕНТАРЬ (MAPPER)
        async function fetchInventory() {
            const sid = document.getElementById('steam-id-input').value.trim();
            const list = document.getElementById('inventory-list');
            const status = document.getElementById('inv-status');

            if (!sid) {
                list.innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:40px;opacity:0.3;">Привяжите Steam ID</p>';
                return;
            }

            status.innerText = "ПОДКЛЮЧЕНИЕ К STEAM...";
            list.innerHTML = '';

            try {
                const r = await fetch(`${API}/api/inventory/${sid}`);
                const data = await r.json();

                // ЛОГИКА СИНХРОНИЗАЦИИ ASSETS И DESCRIPTIONS
                let processedItems = [];

                if (data.assets && data.descriptions) {
                    processedItems = data.assets.map(asset => {
                        const desc = data.descriptions.find(d => d.classid === asset.classid);
                        return {
                            id: asset.assetid,
                            name: desc ? desc.market_hash_name : 'Предмет Steam',
                            icon_url: desc ? desc.icon_url : '',
                            price: '---'
                        };
                    });
                } else if (Array.isArray(data)) {
                    processedItems = data;
                }

                if (processedItems.length === 0) {
                    status.innerText = "ИНВЕНТАРЬ СКРЫТ ИЛИ ПУСТ";
                } else {
                    status.innerText = `ПРЕДМЕТОВ: ${processedItems.length}`;
                    renderItems(processedItems, 'inventory-list', false);
                }
            } catch (e) {
                status.innerText = "ОШИБКА STEAM API";
            }
        }

        function searchSkins() {
            const q = document.getElementById('main-search').value.toLowerCase();
            const filtered = marketItems.filter(i => (i.name || '').toLowerCase().includes(q));
            renderItems(filtered, 'market-list', true);
        }

        function saveSteamId() {
            const sid = document.getElementById('steam-id-input').value.trim();
            if (sid.length > 10) {
                localStorage.setItem('user_sid64', sid);
                showToast('✅ Steam успешно привязан');
                fetchInventory();
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                showToast('❌ Неверный формат ID');
            }
        }

        function showToast(m) {
            const w = document.getElementById('toast-wrap');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = m;
            w.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 3000);
        }

        function setTab(t) {
            document.getElementById('tab-inventory').classList.toggle('active', t === 'inv');
            document.getElementById('tab-history').classList.toggle('active', t === 'hist');
            if (t === 'hist') {
                document.getElementById('inventory-list').innerHTML = '<p style="grid-column:1/-1;text-align:center;padding:50px;opacity:0.2;">История пуста</p>';
                document.getElementById('inv-status').innerText = "";
            } else {
                fetchInventory();
            }
        }

        function buyItem(id) {
            tg.showConfirm('Вы хотите купить этот предмет?');
            tg.HapticFeedback.impactOccurred('medium');
        }

    </script>
</body>
</html>
