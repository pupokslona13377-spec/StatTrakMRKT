<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatTrakMRKT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #0b0e14; color: #fff; overflow-x: hidden; }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
    .page { 
        display: none; 
        padding: 20px; 
        animation: slideIn 0.3s ease-out; 
    }
    .page.active { display: block; }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* –ö—Ä–∞—Å–∏–≤–æ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .nav-bar { 
        position: fixed; 
        bottom: 0; left: 0; right: 0; 
        background: rgba(21, 25, 33, 0.95); 
        backdrop-filter: blur(10px);
        display: flex; 
        justify-content: space-around;
        padding: 10px 0 25px 0; /* –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        z-index: 1000;
    }

    .nav-item { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        color: #6b7280; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 11px;
        gap: 4px;
    }

    .nav-item i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    .nav-item.active { color: #0088cc; transform: translateY(-3px); }
    .nav-item.active i { transform: scale(1.2); filter: drop-shadow(0 0 8px #0088cc); }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å—Ç–∞–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ */
    .item-card { 
        background: #151921; 
        border-radius: 20px; 
        padding: 12px; 
        text-align: center; 
        border: 1px solid #1f2937;
        transition: 0.2s;
    }
    .item-card:active { transform: scale(0.96); background: #1c222d; }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn { 
        width: 100%; padding: 12px; border: none; border-radius: 12px; 
        font-weight: bold; cursor: pointer; transition: 0.2s; 
    }
    .btn-buy { background: linear-gradient(135deg, #0088cc, #00aaff); color: white; box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3); }
    
    /* –ë–∞–ª–∞–Ω—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
    .balance-card { 
        background: linear-gradient(135deg, #1d2633 0%, #0b0e14 100%);
        padding: 25px; border-radius: 24px; border: 1px solid rgba(0, 136, 204, 0.2);
        margin-bottom: 25px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
</style>
</head>
<body>

    <div id="marketPage" class="page active">
        <h2>üõí –ú–∞—Ä–∫–µ—Ç</h2>
        <div style="margin: 10px 0; color: #0088cc;">–ë–∞–ª–∞–Ω—Å: <span id="m-balance">0.00</span> TON</div>
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div id="sellPage" class="page">
        <h2>üí∞ –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div id="status" style="text-align:center; color:#6b7280; margin:10px 0;"></div>
        <div id="inventoryGrid" class="items-grid"></div>
    </div>

    <div id="profilePage" class="page">
        <div class="balance-card">
            <p style="font-size: 14px; opacity: 0.8;">–ë–∞–ª–∞–Ω—Å</p>
            <h1 id="p-balance">0.00 TON</h1>
            <button class="btn btn-success" style="margin-top:10px; width: 160px;" onclick="depositFunds()">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>
        <div style="background: #151921; padding: 15px; border-radius: 12px;">
            <input type="text" id="steamIdInput" placeholder="SteamID64">
            <input type="text" id="tradeUrlInput" placeholder="Trade URL">
            <button class="btn btn-buy" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <div id="ton-connect-button" style="margin-top:20px; display:flex; justify-content:center;"></div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" id="n-market" onclick="switchPage('market')">–ú–∞—Ä–∫–µ—Ç</div>
        <div class="nav-item" id="n-sell" onclick="switchPage('sell')">–ü—Ä–æ–¥–∞—Ç—å</div>
        <div class="nav-item" id="n-profile" onclick="switchPage('profile')">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <script>
        const API_URL = "https://stattrakmrkt.onrender.com";
        const tg = window.Telegram.WebApp;
        let userBalance = parseFloat(localStorage.getItem('balance')) || 0;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://pupokslona13377-spec.github.io/StatTrakMRKT/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        function updateBalanceUI() {
            document.getElementById('m-balance').innerText = userBalance.toFixed(2);
            document.getElementById('p-balance').innerText = userBalance.toFixed(2) + " TON";
            localStorage.setItem('balance', userBalance);
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p + 'Page').classList.add('active');
            document.getElementById('n-' + p).classList.add('active');
            if(p === 'sell') loadInv();
            if(p === 'market') loadMarket();
            updateBalanceUI();
        }

        function saveData() {
            localStorage.setItem('sid', document.getElementById('steamIdInput').value);
            localStorage.setItem('turl', document.getElementById('tradeUrlInput').value);
            tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        }

        async function loadMarket() {
            const grid = document.getElementById('marketGrid');
            try {
                const res = await fetch(`${API_URL}/api/market`);
                const items = await res.json();
                grid.innerHTML = items.map(i => `
                    <div class="item-card">
                        <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.hash}/120x80" class="item-image">
                        <div style="font-size:11px; font-weight:bold;">${i.name}</div>
                        <div style="color:#0088cc; margin:5px 0;">${i.price} TON</div>
                        <button class="btn btn-buy" onclick="buyItem('${i.name}', ${i.price})">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `).join('');
            } catch (e) { grid.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞"; }
        }

        async function listItemForSale(name, hash) {
            const price = prompt(`–¶–µ–Ω–∞ –¥–ª—è ${name} (TON):`, "1.0");
            if (!price || isNaN(price)) return;
            try {
                await fetch(`${API_URL}/api/market/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, hash, sellerSid: localStorage.getItem('sid') })
                });
                tg.showAlert("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ!");
                switchPage('market');
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
        }

        async function loadInv() {
            const sid = localStorage.getItem('sid');
            const grid = document.getElementById('inventoryGrid');
            if(!sid) return;
            grid.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            try {
                const r = await fetch(`${API_URL}/api/inventory/${sid}`);
                const d = await r.json();
                grid.innerHTML = d.descriptions.map(i => `
                    <div class="item-card">
                        <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.icon_url}/120x80" class="item-image">
                        <div style="font-size:10px; height:24px; overflow:hidden;">${i.market_name}</div>
                        <button class="btn btn-success" onclick="listItemForSale('${i.market_name}', '${i.icon_url}')">–ü—Ä–æ–¥–∞—Ç—å</button>
                    </div>
                `).join('');
            } catch(e) { grid.innerHTML = "–û—à–∏–±–∫–∞"; }
        }

        function buyItem(name, price) {
    if (userBalance >= price) {
        tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å ${name} –∑–∞ ${price} TON?`, (ok) => {
            if (ok) {
                userBalance -= price;
                updateBalanceUI();
                tg.showAlert("‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞. –°–∫–∏–Ω —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
            }
        });
    } else {
        tg.showAlert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.");
    }
}

        async function depositFunds() {
            const amount = prompt("–°—É–º–º–∞ (TON):", "1.0");
            if (!amount) return;
            const tx = { validUntil: Math.floor(Date.now()/1000)+60, messages: [{ address: "–í–ê–®_–ö–û–®–ï–õ–ï–ö", amount: (amount*1000000000).toString() }] };
            try { await tonConnectUI.sendTransaction(tx); userBalance += parseFloat(amount); updateBalanceUI(); } catch(e) {}
        }

        document.getElementById('steamIdInput').value = localStorage.getItem('sid') || '';
        document.getElementById('tradeUrlInput').value = localStorage.getItem('turl') || '';
        loadMarket();
        updateBalanceUI();
    </script>
</body>
</html>


