<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StatTrak Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ==================== –ü–û–õ–ù–´–ï –°–¢–ò–õ–ò (UI/UX) ==================== */
        :root {
            --accent: #00D2FF;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text: #212529;
            --ton-color: #0088CC;
            --error: #e74c3c;
            --success: #2ecc71;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* Loader & Notifications */
        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            border-radius: 8px; color: white; font-weight: 500;
            opacity: 0; transform: translateX(400px); transition: all 0.3s ease;
            z-index: 10000; max-width: 300px;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification-error { background: var(--error); }
        .notification-success { background: var(--success); }

        /* Header */
        .header {
            background: var(--card-bg); padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            position: sticky; top: 0; z-index: 100;
        }
        .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 15px; }
        .header-accent { color: var(--accent); }

        .search-box {
            width: 100%; padding: 12px 16px; border: 2px solid #E9ECEF;
            border-radius: 12px; font-size: 15px; background: #F8F9FA;
        }

        /* Sections */
        .section { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Grid */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .item-card {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: 0.3s;
        }
        .item-image { width: 100%; height: 120px; object-fit: contain; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; }
        .item-name { font-size: 13px; font-weight: 600; height: 34px; overflow: hidden; margin-bottom: 6px; }
        .item-price { font-size: 16px; font-weight: 700; color: var(--ton-color); margin-bottom: 8px; }

        .btn-buy {
            width: 100%; padding: 10px; border: none; border-radius: 10px;
            background: var(--accent); color: white; font-weight: 700; cursor: pointer;
        }

        /* Profile & Tabs */
        .profile-card {
            background: linear-gradient(135deg, #00D2FF 0%, #0088CC 100%);
            border-radius: 16px; padding: 25px; color: white; margin-bottom: 20px;
        }
        .balance-value { font-size: 36px; font-weight: 800; margin: 10px 0; }
        .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-wallet {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
        }

        .profile-tabs {
            display: flex; background: #E9ECEF; border-radius: 12px; padding: 4px; margin-bottom: 20px;
        }
        .p-tab {
            flex: 1; text-align: center; padding: 10px; border-radius: 10px;
            font-size: 14px; font-weight: 700; color: #6C757D; cursor: pointer;
        }
        .p-tab.active { background: white; color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Game Hub Blur */
        .game-hub-container { position: relative; border-radius: 16px; overflow: hidden; }
        .blur-content { filter: blur(10px); pointer-events: none; opacity: 0.6; }
        .coming-soon {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: #FFFFFF;
            display: flex; justify-content: space-around; padding: 10px 0 25px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-btn { flex: 1; text-align: center; cursor: pointer; color: #6C757D; transition: 0.3s; }
        .nav-btn.active { color: var(--accent); }
        .nav-icon { display: block; font-size: 22px; }
        .nav-label { font-size: 11px; font-weight: 600; }

        /* History */
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="loader" class="loader"><div class="spinner"></div></div>

    <div class="header">
        <h1>üíé <span class="header-accent">StatTrak</span> Market</h1>
        <input type="text" class="search-box" id="marketSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤...">
    </div>

    <div class="section active" id="market">
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div class="section" id="gameHub">
        <div class="game-hub-container">
            <div class="coming-soon">
                <span style="font-size: 50px;">üéÆ</span>
                <h2>Game Hub</h2>
                <p>–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </div>
            <div class="blur-content">
                <div class="items-grid">
                    <div class="item-card" style="height:150px;"></div>
                    <div class="item-card" style="height:150px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section" id="profile">
        <div class="profile-card">
            <p>–î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</p>
            <div class="balance-value" id="balanceDisplay">0.00 TON</div>
            <div class="wallet-actions">
                <button class="btn-wallet" onclick="showNotification('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ...', 'info')">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                <button class="btn-wallet" onclick="showNotification('–í—ã–≤–æ–¥ –æ—Ç 1 TON', 'info')">‚ûñ –í—ã–≤–µ—Å—Ç–∏</button>
            </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="margin-bottom:10px;">Steam ID64</h3>
            <input type="text" id="steamIdInput" class="search-box" style="margin-bottom:10px;" placeholder="76561198...">
            <button class="btn-buy" onclick="saveSteamId(document.getElementById('steamIdInput').value)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Steam ID</button>
        </div>

        <div class="profile-tabs">
            <div class="p-tab active" id="tab-inventory" onclick="switchProfileTab('inventory')">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div class="p-tab" id="tab-history" onclick="switchProfileTab('history')">–ò—Å—Ç–æ—Ä–∏—è</div>
        </div>

        <div id="inventoryContainer">
            <div class="items-grid" id="inventoryGrid"></div>
        </div>

        <div id="historyContainer" style="display:none;">
            <div class="history-list" id="historyList">
                <div class="history-item">
                    <span>–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥</span>
                    <span style="color:var(--ton-color)">+0.00 TON</span>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-btn active" onclick="switchSection('market')">
            <span class="nav-icon">üõí</span><span class="nav-label">–ú–∞—Ä–∫–µ—Ç</span>
        </div>
        <div class="nav-btn" onclick="switchSection('gameHub')">
            <span class="nav-icon">üéÆ</span><span class="nav-label">–•–∞–±</span>
        </div>
        <div class="nav-btn" onclick="switchSection('profile')">
            <span class="nav-icon">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        /* ==================== –ü–û–õ–ù–ê–Ø –õ–û–ì–ò–ö–ê (JS) ==================== */
        const API_BASE = 'https://stattrakmrkt.onrender.com';
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let currentUser = {
            userId: null,
            steamId: localStorage.getItem('steamId64'),
            balance: 0
        };

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            if (tg.initDataUnsafe?.user?.id) {
                currentUser.userId = tg.initDataUnsafe.user.id;
                localStorage.setItem('userId', currentUser.userId);
            } else {
                currentUser.userId = localStorage.getItem('userId') || 'guest_' + Math.floor(Math.random() * 1000);
            }
            if (currentUser.steamId) {
                document.getElementById('steamIdInput').value = currentUser.steamId;
            }
        }

        // 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Steam ID
        function saveSteamId(steamId) {
            if (!steamId || steamId.length < 10) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SteamID64');
                return;
            }
            currentUser.steamId = steamId;
            localStorage.setItem('steamId64', steamId);
            tg.HapticFeedback.notificationOccurred('success');
            showSuccess('Steam ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            loadInventory(steamId);
        }

        // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –ú–∞—Ä–∫–µ—Ç–∞
        async function loadMarket() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/market`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderMarketItems(data.items || data);
            } catch (error) {
                console.error('Error loading market:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ç');
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è
        async function loadInventory(steamId) {
            if (!steamId) return;
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/inventory/${steamId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                renderInventoryItems(data.items || data);
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ Steam.');
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        // 5. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞
        async function syncBalance() {
            if (!currentUser.userId) return;
            try {
                const response = await fetch(`${API_BASE}/api/user/${currentUser.userId}`);
                if (!response.ok) throw new Error();
                const data = await response.json();
                currentUser.balance = data.balance || 0;
                document.getElementById('balanceDisplay').textContent = `${currentUser.balance.toFixed(2)} TON`;
            } catch (error) {
                console.warn('Balance sync failed');
            }
        }

        // 6. –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
        async function buyItem(itemId, price) {
            if (currentUser.balance < price) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            const confirmed = confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price.toFixed(2)} TON?`);
            if (!confirmed) return;
            try {
                showLoader();
                tg.HapticFeedback.impactOccurred('medium');
                const response = await fetch(`${API_BASE}/api/market/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId, buyerId: currentUser.userId, price })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
                showSuccess('–ü—Ä–µ–¥–º–µ—Ç –∫—É–ø–ª–µ–Ω!');
                tg.HapticFeedback.notificationOccurred('success');
                await syncBalance();
                await loadMarket();
            } catch (error) {
                showError(error.message);
                tg.HapticFeedback.notificationOccurred('error');
            } finally {
                hideLoader();
            }
        }

        // 7. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ú–∞—Ä–∫–µ—Ç–∞
        function renderMarketItems(items) {
            const grid = document.getElementById('marketGrid');
            grid.innerHTML = '';
            if (!items || items.length === 0) {
                grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">–ú–∞—Ä–∫–µ—Ç –ø—É—Å—Ç</p>';
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <img class="item-image" src="${item.image || 'https://via.placeholder.com/150'}" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="item-info">
                        <h3 class="item-name">${item.name}</h3>
                        <p class="item-price">${parseFloat(item.price).toFixed(2)} TON</p>
                        <button class="btn-buy" onclick="buyItem('${item.id}', ${item.price})">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 8. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function renderInventoryItems(items) {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            if (!items || items.length === 0) {
                grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <img class="item-image" src="${item.image}">
                    <div class="item-info">
                        <h3 class="item-name">${item.name}</h3>
                        <input type="number" class="search-box" style="height:35px; margin-bottom:5px; padding:5px;" id="price-${item.id}" placeholder="–¶–µ–Ω–∞ TON">
                        <button class="btn-buy" style="background:var(--ton-color)" onclick="listItemFromInventory('${item.id}', '${item.name}', '${item.market_hash_name || item.name}')">–ü—Ä–æ–¥–∞—Ç—å</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // 9. –í—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É
        async function listItemFromInventory(itemId, name, hash) {
            const priceInput = document.getElementById(`price-${itemId}`);
            const price = parseFloat(priceInput.value);
            if (!price || price <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É');
                return;
            }
            try {
                showLoader();
                const response = await fetch(`${API_BASE}/api/market/list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sellerId: currentUser.userId, steamId: currentUser.steamId, itemName: name, price: price, marketHash: hash })
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–∏');
                showSuccess('–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–∞—Ä–∫–µ—Ç!');
                loadInventory(currentUser.steamId);
            } catch (e) { showError(e.message); }
            finally { hideLoader(); }
        }

        // 10. –£—Ç–∏–ª–∏—Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        function switchSection(id) {
            tg.HapticFeedback.impactOccurred('light');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
            if (id === 'market') loadMarket();
            if (id === 'profile') {
                syncBalance();
                if (currentUser.steamId) loadInventory(currentUser.steamId);
            }
        }

        function switchProfileTab(tab) {
            document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
            if (tab === 'inventory') {
                document.getElementById('tab-inventory').classList.add('active');
                document.getElementById('inventoryContainer').style.display = 'block';
                document.getElementById('historyContainer').style.display = 'none';
            } else {
                document.getElementById('tab-history').classList.add('active');
                document.getElementById('inventoryContainer').style.display = 'none';
                document.getElementById('historyContainer').style.display = 'block';
            }
        }

        // 11. UI Helpers
        function showLoader() { document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        function showError(msg) { showNotification(msg, 'error'); }
        function showSuccess(msg) { showNotification(msg, 'success'); }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // INIT ON START
        initUser();
        syncBalance();
        loadMarket();

    </script>
</body>
</html>



