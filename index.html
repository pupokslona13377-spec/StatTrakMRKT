<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StatTrak Market | CS2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ============================================================
           –ü–û–õ–ù–´–ô –î–ò–ó–ê–ô–ù-–ö–û–î (–ë–ï–ó –°–û–ö–†–ê–©–ï–ù–ò–ô)
           ============================================================ */
        :root {
            --accent: #00D2FF;
            --ton-blue: #0088CC;
            --bg-dark: #0F172A;
            --card-bg: #1E293B;
            --text-main: #F8FAFC;
            --text-dim: #94A3B8;
            --border: rgba(255, 255, 255, 0.08);
            --success: #10B981;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: 110px;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* –°–ü–õ–≠–®-–õ–û–ê–î–ï–† */
        #main-loader {
            position: fixed; inset: 0; background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; transition: 0.5s;
        }
        .spinner {
            width: 45px; height: 45px; border: 3px solid rgba(0, 210, 255, 0.1);
            border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;
        }

        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; pointer-events: none; }
        .toast {
            background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(15px);
            border: 1px solid var(--border); color: white; padding: 14px 20px; border-radius: 14px;
            margin-bottom: 10px; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 12px; animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* HEADER */
        header {
            padding: 20px; background: var(--bg-dark);
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border);
        }
        .logo-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        .tg-badge { font-size: 10px; font-weight: 800; background: var(--card-bg); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border); color: var(--accent); text-transform: uppercase; }

        .search-container { position: relative; }
        .search-input {
            width: 100%; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 14px; padding: 12px 15px 12px 45px; color: white;
            font-size: 15px; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent); background: rgba(30, 41, 59, 0.8); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); opacity: 0.4; font-size: 18px; }

        /* PAGES */
        .page { display: none; padding: 15px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }

        /* MARKET GRID */
        .items-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .item-card {
            background: var(--card-bg); border-radius: 20px; padding: 12px;
            border: 1px solid var(--border); transition: 0.2s; position: relative;
        }
        .item-card:active { transform: scale(0.96); }
        .item-img-container {
            background: radial-gradient(circle, rgba(0,210,255,0.08) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 14px; height: 115px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px;
            overflow: hidden;
        }
        .item-img { max-width: 85%; max-height: 85%; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.4)); }
        .item-name { font-size: 13px; font-weight: 700; height: 38px; overflow: hidden; margin-bottom: 8px; line-height: 1.2; }
        .item-price-row { display: flex; align-items: center; gap: 6px; font-weight: 900; font-size: 16px; color: #fff; }
        
        .ton-icon { width: 18px; height: 18px; fill: var(--ton-blue); }

        .btn-buy {
            width: 100%; padding: 11px; border-radius: 12px; border: none;
            background: var(--accent); color: var(--bg-dark); font-weight: 800;
            font-size: 12px; margin-top: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* GAME HUB */
        .hub-banner {
            position: relative; border-radius: 28px; overflow: hidden;
            min-height: 420px; background: #000; border: 1px solid var(--border);
        }
        .hub-bg-preview {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 20px;
            filter: blur(20px); opacity: 0.3; pointer-events: none;
        }
        .hub-overlay {
            position: absolute; inset: 0; z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle, transparent 0%, var(--bg-dark) 95%);
        }
        .hub-badge {
            background: var(--accent); color: #000; padding: 5px 15px; 
            border-radius: 30px; font-size: 12px; font-weight: 900; margin-top: 15px;
            animation: pulse 2s infinite;
        }

        /* PROFILE */
        .balance-card {
            background: linear-gradient(135deg, #00D2FF 0%, #0088CC 100%);
            border-radius: 28px; padding: 25px; margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 136, 204, 0.3); position: relative; overflow: hidden;
        }
        .balance-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .bal-label { font-size: 12px; font-weight: 800; opacity: 0.8; letter-spacing: 1px; text-transform: uppercase; }
        .bal-value { font-size: 42px; font-weight: 900; margin: 8px 0 25px; display: flex; align-items: center; gap: 12px; }
        .bal-value svg { fill: white; width: 35px; height: 35px; }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; position: relative; z-index: 5; }
        .act-btn {
            background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; padding: 14px; border-radius: 16px; font-weight: 700; font-size: 13px; backdrop-filter: blur(5px);
        }

        .settings-group {
            background: var(--card-bg); border-radius: 24px; padding: 20px;
            margin-bottom: 25px; border: 1px solid var(--border);
        }
        .input-field {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            padding: 14px; border-radius: 14px; color: white; margin: 12px 0; outline: none; font-weight: 600;
        }

        /* NAVIGATION BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); display: flex;
            justify-content: space-around; padding: 12px 10px 35px; z-index: 1000;
        }
        .nav-link {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 800; gap: 5px; transition: 0.3s;
        }
        .nav-link.active { color: var(--accent); }
        .nav-link svg { width: 24px; height: 24px; }

        .empty-state { text-align: center; color: var(--text-dim); padding: 40px 20px; grid-column: 1/-1; }
    </style>
</head>
<body>

    <svg style="display: none;">
        <symbol id="ton-logo" viewBox="0 0 512 512">
            <path d="M256 512c141.385 0 256-114.615 256-256S397.385 0 256 0 0 114.615 0 256s114.615 256 256 256z" fill="#0088CC"/>
            <path d="M229.412 143.529l-92.353 148.236h184.706l-92.353-148.236zm-85.294 171.765L256 414.118l111.882-98.824H144.118z" fill="#FFF"/>
        </symbol>
    </svg>

    <div id="main-loader">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:900; color:var(--accent); letter-spacing: 3px; font-size: 12px;">LOADING MARKET</p>
    </div>

    <div id="toast-container"></div>

    <header>
        <div class="logo-row">
            <div class="logo">STAT<span>TRAK</span></div>
            <div id="user-tag" class="tg-badge">GUEST_USER</div>
        </div>
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchBar" placeholder="–ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        </div>
    </header>

    <main id="view-market" class="page active">
        <div class="items-grid" id="market-render">
            </div>
    </main>

    <section id="view-hub" class="page">
        <div class="hub-banner">
            <div class="hub-overlay">
                <span style="font-size: 60px; margin-bottom: 10px;">üéÆ</span>
                <h2 style="font-size: 32px; font-weight: 900;">GAME HUB</h2>
                <div class="hub-badge">COMING SOON</div>
            </div>
            <div class="hub-bg-preview">
                <div class="item-card" style="height: 120px;"></div>
                <div class="item-card" style="height: 120px;"></div>
                <div class="item-card" style="height: 120px;"></div>
                <div class="item-card" style="height: 120px;"></div>
            </div>
        </div>
    </section>

    <section id="view-profile" class="page">
        <div class="balance-card">
            <p class="bal-label">–î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</p>
            <div class="bal-value">
                <svg><use xlink:href="#ton-logo"></use></svg>
                <span id="bal-amount">0.00</span>
            </div>
            <div class="action-btns">
                <button class="act-btn" onclick="showToast('–î–µ–ø–æ–∑–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
                <button class="act-btn" onclick="showToast('–ú–∏–Ω–∏–º—É–º –¥–ª—è –≤—ã–≤–æ–¥–∞: 1 TON')">–í–´–í–ï–°–¢–ò</button>
            </div>
        </div>

        <div class="settings-group">
            <p style="font-weight: 900; font-size: 14px; color: var(--accent);">STEAM –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø</p>
            <input type="text" id="steamInput" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à SteamID64">
            <button class="btn-buy" style="background: white; color: black;" onclick="saveSteamID()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –ò–ù–í–ï–ù–¢–ê–†–¨</button>
        </div>

        <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 900;">–í–ê–® –ò–ù–í–ï–ù–¢–ê–†–¨</h3>
        <div id="inv-loader-text" style="text-align: center; font-size: 12px; color: var(--accent); margin-bottom: 15px;"></div>
        <div class="items-grid" id="inventory-render">
            </div>
    </section>

    <nav class="nav-bar">
        <a href="javascript:void(0)" class="nav-link active" onclick="navigate('market', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/></svg>
            –ú–ê–†–ö–ï–¢
        </a>
        <a href="javascript:void(0)" class="nav-link" onclick="navigate('hub', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h4M8 10v4M15 13a1 1 0 100-2 1 1 0 000 2z"/></svg>
            –•–ê–ë
        </a>
        <a href="javascript:void(0)" class="nav-link" onclick="navigate('profile', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            –ò–ù–í–ï–ù–¢–ê–†–¨
        </a>
    </nav>

    <script>
        const API = 'https://stattrakmrkt.onrender.com';
        const tg = window.Telegram.WebApp;
        let userData = { sid: localStorage.getItem('steam_id_v64') || '' };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            tg.ready();
            tg.expand();
            if (tg.initDataUnsafe?.user) {
                document.getElementById('user-tag').innerText = tg.initDataUnsafe.user.first_name.toUpperCase();
            }
            if (userData.sid) document.getElementById('steamInput').value = userData.sid;
            
            fetchMarket();
            
            setTimeout(() => {
                document.getElementById('main-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('main-loader').style.display = 'none', 500);
            }, 1200);
        };

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function navigate(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('view-' + page).classList.add('active');
            el.classList.add('active');
            if (page === 'profile') fetchInventory();
            tg.HapticFeedback.impactOccurred('light');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ú–∞—Ä–∫–µ—Ç–∞
        async function fetchMarket() {
            const container = document.getElementById('market-render');
            try {
                const res = await fetch(`${API}/api/market`);
                const items = await res.json();
                
                container.innerHTML = items.map(item => {
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
                    const steamImg = item.image && item.image !== "undefined" ? item.image : 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVdgYpw23d9dfHldogjSA1BW7mD8v_k_W4RS04_IiH6NBX8j66F8WLY';
                    
                    return `
                        <div class="item-card">
                            <div class="item-img-container">
                                <img src="${steamImg}" class="item-img" onerror="this.src='https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVdgYpw23d9dfHldogjSA1BW7mD8v_k_W4RS04_IiH6NBX8j66F8WLY'">
                            </div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-price-row">
                                <svg class="ton-icon"><use xlink:href="#ton-logo"></use></svg>
                                ${item.price}
                            </div>
                            <button class="btn-buy">–ö—É–ø–∏—Ç—å</button>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                container.innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞</div>';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è
        async function fetchInventory() {
            const list = document.getElementById('inventory-render');
            const status = document.getElementById('inv-loader-text');
            
            if (!userData.sid) {
                list.innerHTML = '<div class="empty-state">–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ SteamID64 –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤—ã—à–µ</div>';
                return;
            }

            status.innerText = "‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ Steam...";
            list.innerHTML = '';

            try {
                const res = await fetch(`${API}/api/inventory/${userData.sid}`);
                if (!res.ok) throw new Error();
                
                const data = await res.json();
                const items = Array.isArray(data) ? data : (data.items || []);

                if (items.length === 0) {
                    status.innerText = "‚ùå –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç –∏–ª–∏ —Å–∫—Ä—ã—Ç";
                } else {
                    status.innerText = `‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤: ${items.length}`;
                    list.innerHTML = items.map(i => {
                        const rawImg = i.image || i.icon_url || '';
                        const finalImg = rawImg.includes('http') ? rawImg : `https://community.cloudflare.steamstatic.com/economy/image/${rawImg}`;
                        
                        return `
                            <div class="item-card">
                                <div class="item-img-container">
                                    <img src="${finalImg}" class="item-img" onerror="this.src='https://via.placeholder.com/100?text=Skin'">
                                </div>
                                <div class="item-name">${i.name || i.market_hash_name}</div>
                                <button class="btn-buy" style="background:#fff">–ü—Ä–æ–¥–∞—Ç—å</button>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                status.innerText = "‚ùå –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å ID.";
            }
        }

        function saveSteamID() {
            const val = document.getElementById('steamInput').value.trim();
            if (val.length < 10) return showToast('ID —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
            userData.sid = val;
            localStorage.setItem('steam_id_v64', val);
            showToast('ID —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!');
            fetchInventory();
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<svg style="width:18px;height:18px;"><use xlink:href="#ton-logo"></use></svg> <span>${msg}</span>`;
            container.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 400); }, 3000);
        }
    </script>
</body>
</html>
