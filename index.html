<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StatTrakMRKT</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
   <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #0b0e14; color: #fff; overflow-x: hidden; }
       /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ */

.rarity-common { border-bottom: 4px solid #b0c3d9 !important; background: rgba(176, 195, 217, 0.05); }
.rarity-uncommon { border-bottom: 4px solid #5e98d9 !important; background: rgba(94, 152, 217, 0.05); }
.rarity-rare { border-bottom: 4px solid #4b69ff !important; background: rgba(75, 105, 255, 0.05); }
.rarity-mythical { border-bottom: 4px solid #8847ff !important; background: rgba(136, 71, 255, 0.05); }
.rarity-legendary { border-bottom: 4px solid #d32ce6 !important; background: rgba(211, 44, 230, 0.05); }
.rarity-ancient { border-bottom: 4px solid #eb4b4b !important; background: rgba(235, 75, 75, 0.05); }
.rarity-immortal { border-bottom: 4px solid #e4ae39 !important; background: rgba(228, 174, 57, 0.05); }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
    .page { 
        display: none; 
        padding: 20px; 
        animation: slideIn 0.3s ease-out; 
    }
    .page.active { display: block; }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* –ö—Ä–∞—Å–∏–≤–æ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .nav-bar { 
        position: fixed; 
        bottom: 0; left: 0; right: 0; 
        background: rgba(21, 25, 33, 0.95); 
        backdrop-filter: blur(10px);
        display: flex; 
        justify-content: space-around;
        padding: 10px 0 25px 0; /* –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        z-index: 1000;
    }

    .nav-item { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        color: #6b7280; 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 11px;
        gap: 4px;
    }

    .nav-item i { font-size: 22px; margin-bottom: 2px; transition: 0.3s; }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
    .nav-item.active { color: #0088cc; transform: translateY(-3px); }
    .nav-item.active i { transform: scale(1.2); filter: drop-shadow(0 0 8px #0088cc); }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å—Ç–∞–ª–∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–µ–µ */
    .item-card { 
        background: #151921; 
        border-radius: 20px; 
        padding: 12px; 
        text-align: center; 
        border: 1px solid #1f2937;
        transition: 0.2s;
    }
    .item-card:active { transform: scale(0.96); background: #1c222d; }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn { 
        width: 100%; padding: 12px; border: none; border-radius: 12px; 
        font-weight: bold; cursor: pointer; transition: 0.2s; 
    }
    .btn-buy { background: linear-gradient(135deg, #0088cc, #00aaff); color: white; box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3); }
    
    /* –ë–∞–ª–∞–Ω—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ */
    .balance-card { 
        background: linear-gradient(135deg, #1d2633 0%, #0b0e14 100%);
        padding: 25px; border-radius: 24px; border: 1px solid rgba(0, 136, 204, 0.2);
        margin-bottom: 25px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
</style>
</head>
<body>

    <div id="marketPage" class="page active">
        <h2>üõí –ú–∞—Ä–∫–µ—Ç</h2>
        <div style="margin: 10px 0; color: #0088cc;">–ë–∞–ª–∞–Ω—Å: <span id="m-balance">0.00</span> TON</div>
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div id="sellPage" class="page">
        <h2>üí∞ –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div id="status" style="text-align:center; color:#6b7280; margin:10px 0;"></div>
        <div id="inventoryGrid" class="items-grid"></div>
    </div>

    <div id="profilePage" class="page">
        <div class="balance-card">
            <button class="btn btn-buy" style="background: #2d3748; margin-bottom: 15px;" onclick="showMyItems()">üì¶ –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–æ–¥–∞–∂–µ</button>
<div id="myItemsList" class="items-grid" style="margin-top: 10px;"></div>
            <p style="font-size: 14px; opacity: 0.8;">–ë–∞–ª–∞–Ω—Å</p>
            <h1 id="p-balance">0.00 TON</h1>
            <button class="btn btn-success" style="margin-top:10px; width: 160px;" onclick="depositFunds()">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>
        <div style="background: #151921; padding: 15px; border-radius: 12px;">
            <input type="text" id="steamIdInput" placeholder="SteamID64">
            <input type="text" id="tradeUrlInput" placeholder="Trade URL">
            <button class="btn btn-buy" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <div id="ton-connect-button" style="margin-top:20px; display:flex; justify-content:center;"></div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" id="n-market" onclick="switchPage('market')">
            <i>üõí</i>
            <span>–ú–∞—Ä–∫–µ—Ç</span>
        </div>
        <div class="nav-item" id="n-sell" onclick="switchPage('sell')">
            <i>üí∞</i>
            <span>–ü—Ä–æ–¥–∞—Ç—å</span>
        </div>
        <div class="nav-item" id="n-profile" onclick="switchPage('profile')">
            <i>üë§</i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        const API_URL = "https://stattrakmrkt.onrender.com";
        const tg = window.Telegram.WebApp;
        let userBalance = parseFloat(localStorage.getItem('balance')) || 0;

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://pupokslona13377-spec.github.io/StatTrakMRKT/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        function updateBalanceUI() {
            document.getElementById('m-balance').innerText = userBalance.toFixed(2);
            document.getElementById('p-balance').innerText = userBalance.toFixed(2) + " TON";
            localStorage.setItem('balance', userBalance);
        }

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p + 'Page').classList.add('active');
            document.getElementById('n-' + p).classList.add('active');
            if(p === 'sell') loadInv();
            if(p === 'market') loadMarket();
            updateBalanceUI();
        }

        function saveData() {
            localStorage.setItem('sid', document.getElementById('steamIdInput').value);
            localStorage.setItem('turl', document.getElementById('tradeUrlInput').value);
            tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
        }

       async function loadMarket() {
    const grid = document.getElementById('marketGrid');
    try {
        const res = await fetch(`${API_URL}/api/market`);
        const items = await res.json();
        
        grid.innerHTML = items.map(i => {
            // –ü–µ—á–∞—Ç–∞–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á–µ—Ä–µ–∑ –ü–ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ)
            console.log("–¢–æ–≤–∞—Ä –≤ –º–∞—Ä–∫–µ—Ç–µ:", i.name, "–†–µ–¥–∫–æ—Å—Ç—å:", i.rarity);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º i.rarity, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—É—Å—Ç–æ.
            const rarityClass = i.rarity ? i.rarity : '';
            
            return `
                <div class="item-card ${rarityClass}">
                    <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.hash}/120x80" class="item-image">
                    <div style="font-size:11px; font-weight:bold; height:24px; overflow:hidden;">${i.name}</div>
                    <div style="color:#0088cc; margin:5px 0;">${i.price} TON</div>
                    <button class="btn btn-buy" onclick="buyItem('${i.name}', ${i.price})">–ö—É–ø–∏—Ç—å</button>
                </div>
            `;
        }).join('');
    } catch (e) { 
        grid.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∫–µ—Ç–∞"; 
        console.error(e);
    }
}

       async function listItemForSale(name, hash, rarity) {
    const price = prompt(`–¶–µ–Ω–∞ –¥–ª—è ${name} (TON):`, "1.0");
    if (!price || isNaN(price)) return;
    
    console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", { name, price, hash, rarity });

    try {
        const res = await fetch(`${API_URL}/api/market/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name, 
                price, 
                hash, 
                rarity: rarity, // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ rarity
                sellerSid: localStorage.getItem('sid') 
            })
        });
        if (res.ok) {
            tg.showAlert("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ!");
            switchPage('market');
        }
    } catch (e) { 
        tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"); 
    }
}

       async function loadInv() {
    const sid = localStorage.getItem('sid');
    const grid = document.getElementById('inventoryGrid');
    if(!sid) return;
    grid.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    try {
        const r = await fetch(`${API_URL}/api/inventory/${sid}`);
        const d = await r.json();
        
        grid.innerHTML = d.descriptions.map(i => {
            const rarityClass = getRarityClass(i); 
            console.log("–ù–∞–π–¥–µ–Ω –ø—Ä–µ–¥–º–µ—Ç:", i.market_name, "–ö–ª–∞—Å—Å:", rarityClass);
            return `
                <div class="item-card ${rarityClass}">
                    <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.icon_url}/120x80" class="item-image">
                    <div style="font-size:10px; height:24px; overflow:hidden;">${i.market_name}</div>
                    <button class="btn btn-success" style="font-size:10px;" onclick="listItemForSale('${i.market_name.replace(/'/g, "\\'")}', '${i.icon_url}', '${rarityClass}')">–ü—Ä–æ–¥–∞—Ç—å</button>
                </div>
            `;
        }).join('');
    } catch(e) { grid.innerHTML = "–û—à–∏–±–∫–∞"; }
}

        function buyItem(name, price) {
    if (userBalance >= price) {
        tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å ${name} –∑–∞ ${price} TON?`, (ok) => {
            if (ok) {
                userBalance -= price;
                updateBalanceUI();
                tg.showAlert("‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞. –°–∫–∏–Ω —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
            }
        });
    } else {
        tg.showAlert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.");
    }
}

        async function depositFunds() {
            const amount = prompt("–°—É–º–º–∞ (TON):", "1.0");
            if (!amount) return;
            const tx = { validUntil: Math.floor(Date.now()/1000)+60, messages: [{ address: "–í–ê–®_–ö–û–®–ï–õ–ï–ö", amount: (amount*1000000000).toString() }] };
            try { await tonConnectUI.sendTransaction(tx); userBalance += parseFloat(amount); updateBalanceUI(); } catch(e) {}
        }

        document.getElementById('steamIdInput').value = localStorage.getItem('sid') || '';
        document.getElementById('tradeUrlInput').value = localStorage.getItem('turl') || '';
        loadMarket();
        updateBalanceUI();
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function showMyItems() {
    const sid = localStorage.getItem('sid');
    const container = document.getElementById('myItemsList');
    if (!sid) { tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ SteamID"); return; }

    try {
        const res = await fetch(`${API_URL}/api/market`);
        const allItems = await res.json();
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ sellerSid —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—à–∏–º
        const myItems = allItems.filter(item => item.sellerSid === sid);

        if (myItems.length === 0) {
            container.innerHTML = "<p style='grid-column: 1/3; color: #6b7280;'>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>";
            return;
        }

        container.innerHTML = myItems.map(i => `
            <div class="item-card" id="my-item-${i.id}">
                <img src="https://community.cloudflare.steamstatic.com/economy/image/${i.hash}/120x80" class="item-image">
                <div style="font-size:10px;">${i.name}</div>
                <div style="color:#0088cc; margin:5px 0;">${i.price} TON</div>
                <button class="btn" style="background:#ef4444; font-size:10px;" onclick="removeItem(${i.id})">–°–Ω—è—Ç—å</button>
            </div>
        `).join('');
    } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤"); }
}

// –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
async function removeItem(id) {
    tg.showConfirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–Ω—è—Ç—å —Ç–æ–≤–∞—Ä —Å –ø—Ä–æ–¥–∞–∂–∏?", async (ok) => {
        if (ok) {
            try {
                const res = await fetch(`${API_URL}/api/market/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    tg.showAlert("–¢–æ–≤–∞—Ä —Å–Ω—è—Ç —Å –ø—Ä–æ–¥–∞–∂–∏!");
                    showMyItems(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏"); }
        }
    });
}
        function getRarityClass(item) {
    // –ò—â–µ–º —Ü–≤–µ—Ç –≤ —Ç–µ–≥–∞—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ (Steam –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –µ–≥–æ —Ç–∞–º)
    const colorTag = item.tags ? item.tags.find(t => t.category === "Rarity") : null;
    const color = colorTag ? colorTag.color : "";

    if (color === "b0c3d9") return "rarity-common";
    if (color === "5e98d9") return "rarity-uncommon";
    if (color === "4b69ff") return "rarity-rare";
    if (color === "8847ff") return "rarity-mythical";
    if (color === "d32ce6") return "rarity-legendary";
    if (color === "eb4b4b") return "rarity-ancient";
    if (color === "e4ae39") return "rarity-immortal";
    
    return ""; // –ï—Å–ª–∏ —Ü–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
}
    </script>
</body>
</html>















