<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StatTrak Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --accent: #00d2ff;
            --text-gray: #94a3b8;
        }

        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-darker); color: white; overflow-x: hidden;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; width: 90%; pointer-events: none; }
        .toast {
            background: rgba(30, 41, 59, 0.95); border-left: 4px solid var(--accent);
            backdrop-filter: blur(10px); color: white; padding: 14px 20px;
            border-radius: 12px; margin-bottom: 10px; font-weight: 700;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 12px; font-size: 13px;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg-darker);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 0.5s;
        }
        .loader-ring {
            width: 45px; height: 45px; border: 3px solid rgba(255,255,255,0.05);
            border-top: 3px solid var(--accent); border-radius: 50%;
            animation: rotate-loader 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes rotate-loader { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* –ú–∞—Ä–∫–µ—Ç –∏ –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .items-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; padding-bottom: 100px; }
        .item-card {
            background: #1e293b; border-radius: 18px; padding: 12px;
            position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 8px;
        }
        .item-img-holder { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; display: flex; justify-content: center; }
        .item-img { width: 100%; height: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); }
        .item-name { font-size: 11px; font-weight: 800; text-transform: uppercase; height: 32px; overflow: hidden; }
        .price-tag { display: flex; align-items: center; font-weight: 900; color: var(--accent); font-size: 14px; }
        
        .rarity-line { position: absolute; bottom: 0; left: 0; right: 0; height: 5px; z-index: 10; }
        .rare-covert { background: #eb4b4b; }
        .rare-classified { background: #d32ce6; }
        .rare-restricted { background: #8847ff; }
        .rare-milspec { background: #4b69ff; }
        .rare-gold { background: #e4ae39; }
        .rare-common { background: #b0c3d9; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 15000; align-items: flex-end; justify-content: center; opacity: 0; transition: 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content {
            width: 100%; background: #0f172a; border-radius: 24px 24px 0 0;
            padding: 20px 20px 40px 20px; transform: translateY(100%);
            transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-top: 1px solid rgba(0, 210, 255, 0.3); max-height: 90vh;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        .action-btn {
            width: 100%; height: 45px; border-radius: 12px; border: none;
            font-weight: 900; text-transform: uppercase; cursor: pointer;
            background: var(--accent); color: black;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¢–µ–ª–µ–∂–∫–∏ */
        .cart-container { position: fixed; bottom: 110px; left: -250px; width: 140px; height: 160px; display: none; z-index: 20000; }
        .cart-container.active { display: block; animation: cartMove 5.5s forwards; }
        .cart-emoji { font-size: 100px; position: absolute; bottom: 0; transform: scaleX(-1); }
        #items-box { position: absolute; bottom: 35px; left: 40px; width: 85px; height: 110px; }
        .skin-drop-final { position: absolute; width: 60px; opacity: 0; animation: skinFall 0.6s forwards; }

        @keyframes cartMove { 
            0% { left: -250px; } 35%, 75% { left: 50%; margin-left: -70px; } 100% { left: 130%; } 
        }
        @keyframes skinFall { from { transform: translateY(-100px) scale(0); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .page { display: none; }
        .page.active { display: block; }
        
        /* –ü—Ä–æ—á–µ–µ */
        header { padding: 20px; }
        .logo { font-weight: 900; font-size: 24px; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        .search-wrapper { position: relative; margin-top: 15px; }
        .search-input { width: 100%; background: #1e293b; border: none; padding: 12px 40px; border-radius: 12px; color: white; box-sizing: border-box; }
        
        nav.bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { color: var(--text-gray); text-decoration: none; font-size: 10px; font-weight: 800; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 20px; height: 20px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-ring"></div>
        <div class="logo">STAT<span>TRAK</span></div>
    </div>

    <div id="toast-container"></div>

    <header id="main-header">
        <div class="logo">STAT<span>TRAK</span></div>
        <div id="search-bar-container" class="search-wrapper">
            <input type="text" id="market-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤..." oninput="filterSkins()">
        </div>
    </header>

    <main id="page-market" class="page active">
        <div id="market-list" class="items-grid"></div>
    </main>

    <section id="page-profile" class="page">
        <div style="padding: 20px;">
            <input type="text" id="steam-id-field" class="search-input" placeholder="SteamID64">
            <button class="action-btn" style="margin-top:10px" onclick="handleSteamSync()">–û–ë–ù–û–í–ò–¢–¨ –ò–ù–í–ï–ù–¢–ê–†–¨</button>
            <div id="inventory-info" style="margin: 15px 0; font-size: 12px; color: var(--accent);"></div>
            <div id="inventory-grid" class="items-grid" style="padding:0"></div>
        </div>
    </section>

    <div id="sell-modal" class="modal-overlay" onclick="if(event.target === this) closeSellModal()">
        <div class="modal-content">
            <div id="step-input">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <img id="modal-img" src="" style="width: 70px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                    <div>
                        <h3 id="modal-item-name" style="margin:0; font-size:14px;">NAME</h3>
                        <p style="color:var(--accent); margin:5px 0;">FLOOR: <span id="floor-val">0</span> TON</p>
                    </div>
                </div>
                <input type="number" id="sell-price-input" class="search-input" placeholder="–¶–µ–Ω–∞ –≤ TON" oninput="calculateFee(this.value)">
                <div style="margin: 15px 0; font-size: 12px; opacity: 0.6;">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: <span id="final-receive" style="color:white">0.00</span> TON</div>
                <button class="action-btn" onclick="goToConfirm()">–î–ê–õ–ï–ï</button>
            </div>

            <div id="step-confirm" style="display: none; text-align: center;">
                <h3>–í–´–°–¢–ê–í–ò–¢–¨ –õ–û–¢?</h3>
                <p>–¶–µ–Ω–∞: <span id="confirm-price-val">0</span> TON</p>
                <button class="action-btn" onclick="startCartAnimation()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
                <button class="action-btn" style="background:none; color:white;" onclick="backToInput()">–û–¢–ú–ï–ù–ê</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <div style="height: 160px;">
                <div id="cart-anim" class="cart-container">
                    <div id="items-box"></div>
                    <div class="cart-emoji">üõí</div>
                </div>
            </div>
            <h2>–ì–û–¢–û–í–û!</h2>
            <button class="action-btn" onclick="closeSuccessModal()">–û–¢–õ–ò–ß–ù–û</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="appNavigate('market', this)">–ú–ê–†–ö–ï–¢</a>
        <a href="#" class="nav-item" onclick="appNavigate('profile', this)">–ü–†–û–§–ò–õ–¨</a>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE = 'https://stattrakmrkt.onrender.com';
        let cachedMarket = [];

        window.onload = async () => {
            tg.ready();
            await loadMarketData();
            document.getElementById('loading-screen').style.display = 'none';
        };

        async function loadMarketData() {
            try {
                const res = await fetch(`${API_BASE}/api/market`);
                cachedMarket = await res.json();
                renderItems(cachedMarket, 'market-list', true);
            } catch (e) { console.error(e); }
        }

        function renderItems(items, containerId, isMarket) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => {
                const img = item.icon_url ? (item.icon_url.includes('http') ? item.icon_url : `https://community.cloudflare.steamstatic.com/economy/image/${item.icon_url}/200x200`) : '';
                return `
                <div class="item-card">
                    <div class="item-img-holder"><img src="${img}" class="item-img"></div>
                    <div class="item-name">${item.name || 'Item'}</div>
                    <div class="price-tag">${item.price || '---'} TON</div>
                    <button class="action-btn" onclick="itemAction('${isMarket ? 'buy':'sell'}', '${item.id || item.assetid}')">
                        ${isMarket ? '–ö—É–ø–∏—Ç—å' : '–ü—Ä–æ–¥–∞—Ç—å'}
                    </button>
                </div>`;
            }).join('');
        }

        function itemAction(type, id) {
            if (type === 'buy') {
                tg.showConfirm("–ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?");
            } else {
                const modal = document.getElementById('sell-modal');
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.add('active'), 10);
            }
        }

        function closeSellModal() {
            const m = document.getElementById('sell-modal');
            m.classList.remove('active');
            setTimeout(() => { m.style.display = 'none'; backToInput(); }, 300);
        }

        function goToConfirm() {
            const val = document.getElementById('sell-price-input').value;
            if(!val) return;
            document.getElementById('confirm-price-val').innerText = val;
            document.getElementById('step-input').style.display = 'none';
            document.getElementById('step-confirm').style.display = 'block';
        }

        function backToInput() {
            document.getElementById('step-input').style.display = 'block';
            document.getElementById('step-confirm').style.display = 'none';
        }

        function calculateFee(v) {
            document.getElementById('final-receive').innerText = (v * 0.95).toFixed(2);
        }

        function startCartAnimation() {
            closeSellModal();
            const sm = document.getElementById('success-modal');
            sm.style.display = 'flex';
            setTimeout(() => sm.classList.add('active'), 10);

            const cart = document.getElementById('cart-anim');
            cart.classList.add('active');
            
            // –î–æ–∂–¥—å –∏–∑ —Å–∫–∏–Ω–æ–≤
            setTimeout(() => {
                const box = document.getElementById('items-box');
                for(let i=0; i<3; i++) {
                    setTimeout(() => {
                        const img = document.createElement('img');
                        img.src = 'https://community.cloudflare.steamstatic.com/economy/image/-9a81dlWLwJ2UUGcVs_nsVtzdOEdtWwKGZZLQHTxDZ7I56KU0Zwwo4NUX4oFJZEHLbXH5ApeO4YmlhxYQknCRvCo04DEVlxkKgpou-6kejhjxszFJTwW09Kzm7-FmP7mDLfYkWNF18lwmO7Eu4_xiVXg_0s_Ym3xctXAdVBoZlvR-FfsxL3ph5S9v53AmCc17id253_VyxSygBtMcKUx0iC9f_7E/100fx100f';
                        img.className = 'skin-drop-final';
                        img.style.left = (i * 20) + 'px';
                        box.appendChild(img);
                    }, i * 300);
                }
            }, 1800);
        }

        function closeSuccessModal() {
            const sm = document.getElementById('success-modal');
            sm.classList.remove('active');
            setTimeout(() => { sm.style.display = 'none'; }, 300);
        }

        function appNavigate(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if(page === 'profile') loadInventory();
        }

        async function loadInventory() {
            const sid = document.getElementById('steam-id-field').value;
            if(!sid) return;
            try {
                const res = await fetch(`${API_BASE}/api/inventory/${sid}`);
                const data = await res.json();
                renderItems(data.assets ? data.assets : data, 'inventory-grid', false);
            } catch(e) {}
        }

        function showToast(text) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = text;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>



