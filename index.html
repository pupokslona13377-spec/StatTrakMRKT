<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StatTrak Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F8F9FA; padding-bottom: 80px; }
        .header { background: #FFFFFF; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 100; }
        .header-accent { color: #00D2FF; font-weight: 700; }
        .search-box { width: 100%; padding: 12px; border: 2px solid #E9ECEF; border-radius: 12px; margin-top: 10px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #FFFFFF; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: #6C757D; cursor: pointer; }
        .nav-item.active { color: #00D2FF; border-top: 3px solid #00D2FF; }
        .section { display: none; padding: 20px; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .item-card { background: #FFFFFF; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .item-image { width: 100%; height: 100px; object-fit: contain; }
        .profile-header { background: linear-gradient(135deg, #00D2FF 0%, #0099CC 100%); border-radius: 16px; padding: 25px; color: #FFFFFF; margin-bottom: 20px; }
        .pending-balance { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin-top: 15px; }
        .action-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-cyan { background: #00D2FF; color: white; }
        .game-hub-blur { filter: blur(8px); opacity: 0.5; }
        .coming-soon-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="header">
        <h1>üíé <span class="header-accent">StatTrak Market</span></h1>
        <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤...">
    </div>

    <div class="section active" id="marketSection">
        <div id="marketLoading" class="loading"><div class="spinner"></div></div>
        <div class="items-grid" id="marketGrid"></div>
    </div>

    <div class="section" id="ordersSection">
        <div id="ordersContainer" class="empty-state">
            <div class="empty-icon">üì¶</div>
            <p>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</p>
        </div>
    </div>

    <div class="section" id="gameHubSection">
        <div class="game-hub-container">
            <div class="coming-soon-overlay">
                <h2>üéÆ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h2>
                <p>–ò–≥—Ä–æ–≤–æ–π —Ö–∞–± –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</p>
            </div>
            <div class="game-hub-blur">
                <div class="items-grid">
                    <div class="item-card"><div style="height:100px; background:#eee;"></div></div>
                    <div class="item-card"><div style="height:100px; background:#eee;"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section" id="profileSection">
        <div class="profile-header">
            <div class="balance-label">üí∞ –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
            <div class="balance-amount"><span id="mainBalance">0.00</span> <span class="balance-currency">TON</span></div>
            <div class="pending-balance">
                <div class="pending-label">‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏ (Escrow) <span onclick="alert('–£–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ P2P —Å–¥–µ–ª–∫–∏')">‚ÑπÔ∏è</span></div>
                <div class="pending-amount" id="pendingBalanceDisplay">0.00 TON</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="action-btn btn-cyan" onclick="depositFunds()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="action-btn" style="background: white;" onclick="showToast('–í—ã–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')">–í—ã–≤–æ–¥</button>
        </div>

        <div class="steam-section">
            <h3>üîó Steam –ü—Ä–∏–≤—è–∑–∫–∞</h3>
            <input type="text" id="steamIdInput" class="steam-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à SteamID64">
            <button class="btn-save" onclick="saveSteamID()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>

        <h3 style="margin: 20px 0 10px;">üéí –ú–æ–∏ —Å–∫–∏–Ω—ã</h3>
        <div id="inventoryGrid" class="items-grid"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchSection('market', this)">
            <span class="nav-icon">üõí</span><span class="nav-label">–ú–∞—Ä–∫–µ—Ç</span>
        </div>
        <div class="nav-item" onclick="switchSection('orders', this)">
            <span class="nav-icon">üìã</span><span class="nav-label">–ó–∞–∫–∞–∑—ã</span>
        </div>
        <div class="nav-item" onclick="switchSection('gameHub', this)">
            <span class="nav-icon">üéÆ</span><span class="nav-label">–•–∞–±</span>
        </div>
        <div class="nav-item" onclick="switchSection('profile', this)">
            <span class="nav-icon">üë§</span><span class="nav-label">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        const API_URL = "https://stattrakmrkt.onrender.com";
        const tg = window.Telegram.WebApp;
        tg.expand();

        let userId = tg.initDataUnsafe?.user?.id || 1234567;

        function showToast(text) {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = text;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        function switchSection(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            el.classList.add('active');
            if(id === 'market') loadMarket();
            if(id === 'profile') loadInventory();
        }

        async function loadMarket() {
            const grid = document.getElementById('marketGrid');
            try {
                const res = await fetch(`${API_URL}/api/market`);
                const items = await res.json();
                grid.innerHTML = items.map(i => `
                    <div class="item-card">
                        <img class="item-image" src="https://community.cloudflare.steamstatic.com/economy/image/${i.hash}/200fx200f">
                        <div class="item-name">${i.name}</div>
                        <div class="item-price">üíé ${i.price} TON</div>
                        <button class="action-btn btn-cyan" style="padding: 8px; font-size: 12px;" onclick="buyItem('${i.id}', ${i.price})">–ö—É–ø–∏—Ç—å</button>
                    </div>
                `).join('');
            } catch(e) { grid.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
            document.getElementById('marketLoading').style.display = 'none';
        }

        async function loadInventory() {
            const sid = localStorage.getItem('sid');
            const grid = document.getElementById('inventoryGrid');
            if(!sid) { grid.innerHTML = "–í–≤–µ–¥–∏—Ç–µ SteamID64 –≤ –ø–æ–ª–µ –≤—ã—à–µ"; return; }
            
            try {
                const res = await fetch(`${API_URL}/api/inventory/${sid}`);
                const data = await res.json();
                if(data.descriptions) {
                    grid.innerHTML = data.descriptions.map(item => `
                        <div class="item-card">
                            <img class="item-image" src="https://community.cloudflare.steamstatic.com/economy/image/${item.icon_url}/200fx200f">
                            <div class="item-name">${item.market_name}</div>
                            <button class="action-btn" style="padding: 8px; font-size: 12px; background: #eee;" onclick="listItem('${item.market_name}', '${item.icon_url}')">–ü—Ä–æ–¥–∞—Ç—å</button>
                        </div>
                    `).join('');
                }
            } catch(e) { grid.innerHTML = "–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–µ –Ω–∞–π–¥–µ–Ω"; }
        }

        function saveSteamID() {
            const val = document.getElementById('steamIdInput').value;
            if(val.length < 15) return alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SteamID");
            localStorage.setItem('sid', val);
            showToast("ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
            loadInventory();
        }

        async function depositFunds() {
            const amount = prompt("–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (—Ç–µ—Å—Ç):", "1.0");
            if(!amount) return;
            await fetch(`${API_URL}/api/user/deposit`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, amount: parseFloat(amount) })
            });
            updateBalance();
        }

        async function updateBalance() {
            const res = await fetch(`${API_URL}/api/user/${userId}`);
            const data = await res.json();
            document.getElementById('mainBalance').innerText = data.balance.toFixed(2);
        }

        async function buyItem(id, price) {
            if(!confirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price} TON?`)) return;
            const res = await fetch(`${API_URL}/api/market/buy`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ userId, itemId: id })
            });
            if(res.ok) { showToast("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!"); updateBalance(); loadMarket(); }
            else { showToast("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞"); }
        }

        window.onload = () => {
            loadMarket();
            updateBalance();
            document.getElementById('steamIdInput').value = localStorage.getItem('sid') || '';
        };
    </script>
</body>
</html>


